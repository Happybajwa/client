{"ast":null,"code":"import { createAsyncThunk, isAnyOf } from '@reduxjs/toolkit';\nimport { createSlice } from '@reduxjs/toolkit';\nimport Agent from '../../App/Api/Agent';\nimport { history } from '../..';\nimport { setBasket } from '../Basket/BasketSlice';\nconst initialState = {\n  user: null\n};\nexport const signInUser = createAsyncThunk('/account/signInUser', async (data, thunkAPI) => {\n  try {\n    const userDto = await Agent.Account.login(data);\n    const {\n      basket,\n      ...user\n    } = userDto;\n    if (basket) thunkAPI.dispatch(setBasket(basket));\n    localStorage.setItem('user', JSON.stringify(user));\n    return user;\n  } catch (error) {\n    return thunkAPI.rejectWithValue({\n      error: error.data\n    });\n  }\n});\nexport const fetchCurrentUser = createAsyncThunk('/account/fetchCurrentUser', async (_, thunkAPI) => {\n  thunkAPI.dispatch(setUser(JSON.parse(localStorage.getItem('user'))));\n\n  try {\n    const userDto = await Agent.Account.currentUser();\n    const {\n      basket,\n      ...user\n    } = userDto;\n    if (basket) thunkAPI.dispatch(setBasket(basket));\n    localStorage.setItem('user', JSON.stringify(user));\n    return user;\n  } catch (error) {\n    return thunkAPI.rejectWithValue({\n      error: error.data\n    });\n  }\n}, {\n  condition: () => {\n    if (!localStorage.getItem('user')) return false;\n  }\n});\nexport const accountSlice = createSlice({\n  name: 'account',\n  initialState,\n  reducers: {\n    signOut: state => {\n      state.user = null;\n      localStorage.removeItem('user');\n      history.push('./login');\n    },\n    setUser: (state, action) => {\n      let claims = JSON.parse(atob(action.payload.token.split('.')[1]));\n      let roles = claims['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];\n      state.user = { ...action.payload,\n        roles: typeof roles === 'string' ? [roles] : roles\n      };\n    }\n  },\n  extraReducers: builder => {\n    builder.addCase(fetchCurrentUser.rejected, state => {\n      state.user = null;\n      localStorage.removeItem('user');\n      history.push('/catalog');\n    });\n    builder.addMatcher(isAnyOf(signInUser.fulfilled, fetchCurrentUser.fulfilled), (state, action) => {\n      let claims = JSON.parse(atob(action.payload.token.split('.')[1]));\n      let roles = claims['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];\n      state.user = { ...action.payload,\n        roles: typeof roles === 'string' ? [roles] : roles\n      };\n      con;\n      state.user = action.payload;\n    });\n    builder.addMatcher(isAnyOf(signInUser.rejected, fetchCurrentUser.rejected), (state, action) => {\n      throw action.payload;\n    });\n  }\n});\nexport const {\n  signOut,\n  setUser\n} = accountSlice.actions;","map":{"version":3,"names":["createAsyncThunk","isAnyOf","createSlice","Agent","history","setBasket","initialState","user","signInUser","data","thunkAPI","userDto","Account","login","basket","dispatch","localStorage","setItem","JSON","stringify","error","rejectWithValue","fetchCurrentUser","_","setUser","parse","getItem","currentUser","condition","accountSlice","name","reducers","signOut","state","removeItem","push","action","claims","atob","payload","token","split","roles","extraReducers","builder","addCase","rejected","addMatcher","fulfilled","con","actions"],"sources":["D:/Project/client/src/Features/Account/AccountSlice.ts"],"sourcesContent":["import { FieldValues } from 'react-hook-form';\r\nimport { createAsyncThunk, isAnyOf } from '@reduxjs/toolkit';\r\nimport { createSlice } from '@reduxjs/toolkit';\r\nimport { User } from \"../../App/Models/User\";\r\nimport Agent from '../../App/Api/Agent';\r\nimport { history } from '../..';\r\nimport { setBasket } from '../Basket/BasketSlice';\r\n\r\ninterface AccountState {\r\n    user: User | null;\r\n}\r\n\r\nconst initialState: AccountState = {\r\n    user: null\r\n}\r\n\r\nexport const signInUser = createAsyncThunk<User, FieldValues>(\r\n    '/account/signInUser',\r\n    async (data, thunkAPI) => {\r\n        try {\r\n            const userDto = await Agent.Account.login(data);\r\n            const {basket, ...user} = userDto;\r\n\r\n            if(basket) thunkAPI.dispatch(setBasket(basket));\r\n            localStorage.setItem('user', JSON.stringify(user));\r\n            return user;\r\n        }\r\n        catch (error: any) {\r\n            return thunkAPI.rejectWithValue({ error: error.data })\r\n        }\r\n    }\r\n)\r\n\r\nexport const fetchCurrentUser = createAsyncThunk(\r\n    '/account/fetchCurrentUser',\r\n    async (_, thunkAPI) => {\r\n        thunkAPI.dispatch(setUser(JSON.parse(localStorage.getItem('user')!)));\r\n        try {\r\n            const userDto = await Agent.Account.currentUser();\r\n            const {basket, ...user} = userDto;\r\n            if(basket) thunkAPI.dispatch(setBasket(basket));\r\n            localStorage.setItem('user', JSON.stringify(user));\r\n            return user;\r\n        }\r\n        catch (error: any) {\r\n            return thunkAPI.rejectWithValue({ error: error.data })\r\n        }\r\n    },\r\n    {\r\n        condition: () => {\r\n            if(!localStorage.getItem('user')) return false;\r\n        }\r\n    }\r\n)\r\n\r\nexport const accountSlice = createSlice({\r\n    name: 'account',\r\n    initialState,\r\n    reducers: {\r\n        signOut:(state) => {\r\n            state.user = null;\r\n            localStorage.removeItem('user');\r\n            history.push('./login')\r\n        },\r\n        setUser:(state, action)=>{\r\n\r\n            let claims = JSON.parse(atob(action.payload.token.split('.')[1]));\r\n            let roles = claims['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];\r\n            state.user = {\r\n                ...action.payload, \r\n                roles: typeof(roles)=== 'string' ? [roles]: roles,\r\n            };\r\n        }\r\n    },\r\n    extraReducers: (builder => {\r\n        builder.addCase(fetchCurrentUser.rejected,(state) => {\r\n            state.user = null;\r\n            localStorage.removeItem('user');\r\n            history.push('/catalog');\r\n        });\r\n        builder.addMatcher(isAnyOf(signInUser.fulfilled, fetchCurrentUser.fulfilled),\r\n            (state, action) => {\r\n                let claims = JSON.parse(atob(action.payload.token.split('.')[1]));\r\n                let roles = claims['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];\r\n                state.user = {\r\n                    ...action.payload, \r\n                    roles: typeof(roles) === 'string' ? [roles]: roles,\r\n                };\r\n                con\r\n                state.user = action.payload\r\n            });\r\n        builder.addMatcher(isAnyOf(signInUser.rejected, fetchCurrentUser.rejected),\r\n            (state, action) => {\r\n                throw action.payload;\r\n            });\r\n    })\r\n})\r\n\r\nexport const {signOut, setUser} = accountSlice.actions;"],"mappings":"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"},"metadata":{},"sourceType":"module"}